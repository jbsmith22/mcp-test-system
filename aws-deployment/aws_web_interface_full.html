<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEJM Research Assistant - AWS Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 0;
            min-height: 600px;
        }
        
        .search-panel {
            padding: 30px;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-left: 1px solid #e9ecef;
        }
        
        .search-form {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        
        .results {
            margin-top: 30px;
        }
        
        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .result-type {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .result-content {
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .sources {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .source-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }
        
        .source-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .source-meta {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f2f6;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-value {
            font-weight: 600;
            color: #667eea;
        }
        
        .health-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .health-healthy { background: #27ae60; }
        .health-degraded { background: #f39c12; }
        .health-error { background: #e74c3c; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fcc;
            margin: 20px 0;
        }
        
        .success {
            background: #efe;
            color: #363;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #cfc;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† NEJM Research Assistant</h1>
            <p>AWS-powered medical literature search with AI analysis</p>
        </div>
        
        <div class="main-content">
            <div class="search-panel">
                <div class="search-form">
                    <div class="form-group">
                        <label for="query">Research Question</label>
                        <textarea id="query" placeholder="What would you like to know about medical AI research?">artificial intelligence in healthcare</textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="limit">Max Results</label>
                            <select id="limit">
                                <option value="3">3 sources</option>
                                <option value="5" selected>5 sources</option>
                                <option value="10">10 sources</option>
                                <option value="15">15 sources</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="search-type">Search Type</label>
                            <select id="search-type">
                                <option value="hybrid" selected>Hybrid (Text + AI)</option>
                                <option value="text">Text Only</option>
                                <option value="vector">Semantic Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="performSearch()">üîç AI Research Search</button>
                    <button class="btn btn-secondary" onclick="performDirectSearch()">üìÑ Direct Search</button>
                </div>
                
                <div id="results" class="results"></div>
            </div>
            
            <div class="sidebar">
                <div class="stats-card">
                    <h3>üìä Database Status</h3>
                    <div id="db-stats">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading stats...
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>üîß System Health</h3>
                    <div id="health-status">
                        <div class="stat-item">
                            <span><span class="health-indicator health-healthy"></span>AWS OpenSearch</span>
                            <span class="stat-value">healthy</span>
                        </div>
                        <div class="stat-item">
                            <span><span class="health-indicator health-healthy"></span>Bedrock AI</span>
                            <span class="stat-value">healthy</span>
                        </div>
                        <div class="stat-item">
                            <span><span class="health-indicator health-healthy"></span>API Gateway</span>
                            <span class="stat-value">healthy</span>
                        </div>
                        <div class="stat-item">
                            <span><span class="health-indicator health-healthy"></span>Lambda</span>
                            <span class="stat-value">healthy</span>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>üîí Security Status</h3>
                    <div id="security-status">
                        <div class="loading">
                            <div class="spinner"></div>
                            Checking security...
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>üì• Import Articles</h3>
                    <div class="form-group">
                        <label for="import-source">Source</label>
                        <select id="import-source">
                            <option value="nejm">NEJM Journal</option>
                            <option value="nejm-ai">NEJM AI</option>
                            <option value="catalyst">Catalyst</option>
                            <option value="evidence">Evidence</option>
                            <option value="clinician">Clinician</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="import-count">Articles to Import</label>
                        <select id="import-count">
                            <option value="10">10 articles</option>
                            <option value="25">25 articles</option>
                            <option value="50">50 articles</option>
                            <option value="100">100 articles</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="importArticles()" style="width: 100%; margin-bottom: 10px;" id="import-btn">üì• Import Articles</button>
                    <div id="import-status" style="font-size: 12px; color: #7f8c8d;"></div>
                </div>
                
                <div class="stats-card">
                    <h3>üìö Quick Actions</h3>
                    <button class="btn" onclick="refreshStats()" style="width: 100%; margin-bottom: 10px;">üîÑ Refresh Stats</button>
                    <button class="btn btn-secondary" onclick="testAPI()" style="width: 100%;">üß™ Test API</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // AWS API Configuration
        const API_BASE_URL = 'https://lwi6jeeczi.execute-api.us-east-1.amazonaws.com/prod/research';
        const API_KEY = 'YOUR_API_KEY_HERE';
        
        // Global state
        let currentStats = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshStats();
            checkSecurity();
            
            // Auto-refresh every 60 seconds
            setInterval(refreshStats, 60000);
            setInterval(checkSecurity, 120000); // Check security every 2 minutes
        });
        
        // Refresh database statistics
        async function refreshStats() {
            const statsDiv = document.getElementById('db-stats');
            statsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Loading stats...</div>';
            
            try {
                console.log('Testing API connection...');
                
                // Test API to get basic info
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify({
                        query: 'test',
                        limit: 1
                    })
                });
                
                console.log('API Response status:', response.status);
                
                // Try to get actual database statistics
                try {
                    // Make a broad search to get total count
                    const countResponse = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: "medical OR research OR nejm OR article OR study",
                            max_results: 1000
                        })
                    });
                    
                    if (countResponse.ok) {
                        const countResult = await countResponse.json();
                        console.log('Count API Response:', countResult);
                        
                        if (countResult.sources && Array.isArray(countResult.sources)) {
                            const totalCount = countResult.sources.length;
                            console.log(`‚úÖ Got actual count from database: ${totalCount}`);
                            
                            // Count articles by source
                            const sourceCounts = {};
                            countResult.sources.forEach(source => {
                                const sourceKey = source.source || 'unknown';
                                sourceCounts[sourceKey] = (sourceCounts[sourceKey] || 0) + 1;
                            });
                            
                            const html = `
                                <div class="stat-item">
                                    <span>Total Articles</span>
                                    <span class="stat-value" style="color: #27ae60;">${totalCount}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Database Size</span>
                                    <span class="stat-value">${Math.round(totalCount * 0.1)} MB</span>
                                </div>
                                <div class="stat-item">
                                    <span>Search Engine</span>
                                    <span class="stat-value">OpenSearch</span>
                                </div>
                                <div class="stat-item">
                                    <span>AI Model</span>
                                    <span class="stat-value">Claude 3.5</span>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;"><strong>By Source:</strong></div>
                                ${Object.entries(sourceCounts).map(([source, count]) => `
                                    <div class="stat-item">
                                        <span>${source}</span>
                                        <span class="stat-value">${count} articles</span>
                                    </div>
                                `).join('')}
                                <div class="stat-item">
                                    <span>Database Status</span>
                                    <span class="stat-value" style="color: #27ae60;">‚úÖ Live Data</span>
                                </div>
                            `;
                            
                            statsDiv.innerHTML = html;
                            return; // Success - exit here
                        }
                    }
                    
                    // If we get here, the API call didn't return expected data
                    throw new Error(`API returned unexpected format: ${countResponse.status}`);
                    
                } catch (error) {
                    console.error('‚ùå Failed to get database statistics:', error);
                    
                    // Show error state - no fake numbers
                    const html = `
                        <div class="stat-item">
                            <span>Total Articles</span>
                            <span class="stat-value" style="color: #e74c3c;">‚ùå API Error</span>
                        </div>
                        <div class="stat-item">
                            <span>Database Status</span>
                            <span class="stat-value" style="color: #e74c3c;">Connection Failed</span>
                        </div>
                        <div class="stat-item">
                            <span>Error Details</span>
                            <span class="stat-value" style="font-size: 11px;">${error.message}</span>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 12px;">
                            <strong>‚ö†Ô∏è Cannot retrieve live statistics</strong><br>
                            Check API connectivity and try refreshing.
                        </div>
                    `;
                    
                    statsDiv.innerHTML = html;
                }
        }
        
        // Perform AI research search using AWS API
        async function performSearch() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                alert('Please enter a research question');
                return;
            }
            
            const limit = parseInt(document.getElementById('limit').value);
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Searching and generating AI answer...</div>';
            
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: limit
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const result = await response.json();
                
                let html = `
                    <div class="result-card">
                        <div class="result-header">
                            <span class="result-type">AI Answer</span>
                            <span style="font-size: 12px; color: #7f8c8d;">Generated by ${result.system}</span>
                        </div>
                        <div class="result-content">
                            ${result.answer.replace(/\n/g, '<br>')}
                        </div>
                `;
                
                if (result.sources && result.sources.length > 0) {
                    html += '<div class="sources"><h4>üìö Sources Used:</h4>';
                    
                    result.sources.forEach((source, index) => {
                        const score = (source.score * 100 / 25).toFixed(1); // Normalize score
                        
                        html += `
                            <div class="source-item">
                                <div class="source-title">${index + 1}. ${source.title}</div>
                                <div class="source-meta">
                                    Relevance: ${score}% | 
                                    DOI: ${source.doi || 'N/A'} | 
                                    Year: ${source.year || 'Unknown'} | 
                                    Source: ${source.source || 'Unknown'}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += '<div class="sources"><h4>‚ö†Ô∏è No specific sources found, but AI generated a general response</h4></div>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Search failed: ${error.message}</div>`;
            }
        }
        
        // Perform direct search (just sources, no AI answer)
        async function performDirectSearch() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            const limit = parseInt(document.getElementById('limit').value);
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Searching articles...</div>';
            
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: limit
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const result = await response.json();
                
                let html = `
                    <div class="result-card">
                        <div class="result-header">
                            <span class="result-type">Direct Search Results</span>
                            <span style="font-size: 12px; color: #7f8c8d;">Found ${result.sources ? result.sources.length : 0} articles</span>
                        </div>
                `;
                
                if (result.sources && result.sources.length > 0) {
                    html += '<div class="sources">';
                    
                    result.sources.forEach((source, index) => {
                        const score = (source.score * 100 / 25).toFixed(1);
                        
                        html += `
                            <div class="source-item">
                                <div class="source-title">${index + 1}. ${source.title}</div>
                                <div class="source-meta">
                                    Relevance: ${score}% | 
                                    DOI: ${source.doi || 'N/A'} | 
                                    Year: ${source.year || 'Unknown'} | 
                                    Source: ${source.source || 'Unknown'}
                                </div>
                                <div style="margin-top: 8px; font-size: 14px; color: #555;">
                                    ${source.abstract || 'No abstract available'}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += '<div class="result-content">No articles found for this query. Try different keywords.</div>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Search failed: ${error.message}</div>`;
            }
        }
        
        // Test API connection
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Testing API connection...</div>';
            
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify({
                        query: 'cardiac rehabilitation',
                        limit: 2
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const result = await response.json();
                
                const html = `
                    <div class="result-card">
                        <div class="result-header">
                            <span class="result-type">API Test Results</span>
                        </div>
                        <div class="result-content">
                            <div class="success">
                                ‚úÖ API Connection: Working<br>
                                ‚úÖ Authentication: Valid<br>
                                ‚úÖ Sources Found: ${result.sources ? result.sources.length : 0}<br>
                                ‚úÖ AI Response: ${result.answer ? 'Generated' : 'Not generated'}<br>
                                ‚úÖ Response Time: ${result.timestamp ? 'Normal' : 'Unknown'}
                            </div>
                            <p><strong>System:</strong> ${result.system || 'Unknown'}</p>
                            <p><strong>Timestamp:</strong> ${result.timestamp || 'Unknown'}</p>
                        </div>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result-card">
                        <div class="result-header">
                            <span class="result-type">API Test Results</span>
                        </div>
                        <div class="result-content">
                            <div class="error">
                                ‚ùå API Test Failed: ${error.message}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Import articles (placeholder - would need backend implementation)
        async function importArticles() {
            const source = document.getElementById('import-source').value;
            const count = parseInt(document.getElementById('import-count').value);
            const importBtn = document.getElementById('import-btn');
            const importStatus = document.getElementById('import-status');
            
            // Disable button and show status
            importBtn.disabled = true;
            importBtn.textContent = '‚è≥ Importing...';
            importStatus.innerHTML = `<div style="color: #667eea;">Import functionality requires backend implementation for ${source.toUpperCase()} (${count} articles)</div>`;
            
            // Simulate import process
            setTimeout(() => {
                importStatus.innerHTML = `<div style="color: #f39c12;">‚ö†Ô∏è Import feature not yet implemented for AWS version</div>`;
                importBtn.disabled = false;
                importBtn.textContent = 'üì• Import Articles';
                
                // Clear status after 5 seconds
                setTimeout(() => {
                    importStatus.innerHTML = '';
                }, 5000);
            }, 2000);
        }
        
        // Check security status
        async function checkSecurity() {
            const securityDiv = document.getElementById('security-status');
            securityDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Checking security...</div>';
            
            try {
                // Get current IP
                const ipResponse = await fetch('https://ipinfo.io/ip');
                const currentIP = await ipResponse.text();
                
                // Test API access to determine if IP is allowed
                const testResponse = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify({
                        query: 'security test',
                        limit: 1
                    })
                });
                
                let securityStatus = 'unknown';
                let statusColor = '#f39c12';
                let statusIcon = '‚ö†Ô∏è';
                
                if (testResponse.ok) {
                    const result = await testResponse.json();
                    
                    // Check if security info is in response
                    if (result.security) {
                        if (result.security.ip_validated) {
                            securityStatus = 'secured';
                            statusColor = '#27ae60';
                            statusIcon = 'üîí';
                        } else {
                            securityStatus = 'open';
                            statusColor = '#e74c3c';
                            statusIcon = 'üîì';
                        }
                    } else {
                        securityStatus = 'partial';
                        statusColor = '#f39c12';
                        statusIcon = '‚ö†Ô∏è';
                    }
                } else if (testResponse.status === 403) {
                    securityStatus = 'blocked';
                    statusColor = '#e74c3c';
                    statusIcon = 'üö´';
                } else {
                    securityStatus = 'error';
                    statusColor = '#e74c3c';
                    statusIcon = '‚ùå';
                }
                
                const html = `
                    <div class="stat-item">
                        <span>Your IP</span>
                        <span class="stat-value" style="font-family: monospace;">${currentIP}</span>
                    </div>
                    <div class="stat-item">
                        <span>${statusIcon} Access Status</span>
                        <span class="stat-value" style="color: ${statusColor};">${securityStatus}</span>
                    </div>
                    <div class="stat-item">
                        <span>üåê Website</span>
                        <span class="stat-value" style="color: ${statusColor};">IP restricted</span>
                    </div>
                    <div class="stat-item">
                        <span>üîë API</span>
                        <span class="stat-value" style="color: ${statusColor};">Key + IP auth</span>
                    </div>
                `;
                
                securityDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Security check error:', error);
                securityDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Security check failed<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        // Handle Enter key in query textarea
        document.getElementById('query').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                performSearch();
            }
        });
    </script>
</body>
</html>